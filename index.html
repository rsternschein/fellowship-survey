<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCCM Fellowship Evaluation Survey</title>
    <style>
        :root {
            --bwh-blue: #003e7e; --mgh-blue: #007398; --bidmc-red: #c41230; --va-green: #2e4d3b; --gray-bg: #e9ecef;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1350px; margin: 0 auto; padding: 40px 20px; background-color: var(--gray-bg); }
        .section-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; display: none; }
        .active-section { display: block; }
        h1 { color: var(--bwh-blue); text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; color: var(--bwh-blue); }
        .table-wrapper { max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; margin-top: 15px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; margin-bottom: 20px; }
        thead th { background: #444; color: white; padding: 12px; font-size: 0.85em; position: sticky; top: 0; z-index: 10; }
        td { border: 1px solid #dee2e6; padding: 10px; vertical-align: middle; }
        .col-name { width: 320px; font-weight: bold; background: #f9f9f9; font-size: 0.9em; }
        .center-cell { text-align: center; }
        .row-disabled { background-color: #f2f2f2 !important; color: #aaa; }
        .row-disabled textarea { opacity: 0.3; pointer-events: none; }
        .hospital-block { margin-bottom: 30px; padding: 20px; border-radius: 8px; border-left: 8px solid #ccc; background: #fff; }
        .bwh { border-left-color: var(--bwh-blue); } .mgh { border-left-color: var(--mgh-blue); } .bidmc { border-left-color: var(--bidmc-red); } .va { border-left-color: var(--va-green); }
        textarea { width: 100%; height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; box-sizing: border-box; font-family: inherit; }
        .nav-container { margin-top: 30px; display: flex; justify-content: space-between; }
        .btn { padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; }
        .btn-next { background: var(--bwh-blue); color: white; }
        .btn-prev { background: #6c757d; color: white; }
        .btn-submit { background: #28a745; color: white; }
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000; text-align: center; padding-top: 200px; font-size: 1.5em; color: var(--bwh-blue); }
        .hidden-content { display: none; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; }
    </style>
</head>
<body>

<div id="loadingOverlay">Submitting Anonymously...</div>

<h1>PCCM Fellowship Evaluation Survey</h1>

<div id="section1" class="section-card active-section">
    <h2>(1) Clinical Rotation Feedback</h2>
    <div class="hospital-block bwh">
        <strong>Did you do any rotations at BWH?</strong> &nbsp;
        <input type="radio" name="bwh_radio" onclick="toggleHospital('bwh', true)"> Yes
        <input type="radio" name="bwh_radio" onclick="toggleHospital('bwh', false)"> No
        <div id="bwh_content" style="display:none;" class="table-wrapper"><table id="bwh_table"></table></div>
    </div>
    <div class="hospital-block mgh">
        <strong>Did you do any rotations at MGH?</strong> &nbsp;
        <input type="radio" name="mgh_radio" onclick="toggleHospital('mgh', true)"> Yes
        <input type="radio" name="mgh_radio" onclick="toggleHospital('mgh', false)"> No
        <div id="mgh_content" style="display:none;" class="table-wrapper"><table id="mgh_table"></table></div>
    </div>
    <div class="hospital-block bidmc">
        <strong>Did you do any rotations at BIDMC?</strong> &nbsp;
        <input type="radio" name="bidmc_radio" onclick="toggleHospital('bidmc', true)"> Yes
        <input type="radio" name="bidmc_radio" onclick="toggleHospital('bidmc', false)"> No
        <div id="bidmc_content" style="display:none;" class="table-wrapper"><table id="bidmc_table"></table></div>
    </div>
    <div class="hospital-block va">
        <strong>Did you do any rotations at the VA?</strong> &nbsp;
        <input type="radio" name="va_radio" onclick="toggleHospital('va', true)"> Yes
        <input type="radio" name="va_radio" onclick="toggleHospital('va', false)"> No
        <div id="va_content" style="display:none;" class="table-wrapper"><table id="va_table"></table></div>
    </div>
    <div class="nav-container"><div></div><button class="btn btn-next" onclick="showSection(2)">Continue to Section 2 →</button></div>
</div>

<div id="section2" class="section-card">
    <h2>(2) Pulmonary Training</h2>
    <div id="pulm_content"></div>
    <h3>Suggestions for improvement (Pulmonary):</h3>
    <textarea data-name="Suggestions_Pulm" placeholder="Your feedback..."></textarea>
    <div id="pulm_time_content"></div>
    <div class="nav-container"><button class="btn btn-prev" onclick="showSection(1)">← Back</button><button class="btn btn-next" onclick="showSection(3)">Continue →</button></div>
</div>

<div id="section3" class="section-card">
    <h2>(3) Critical Care Training</h2>
    <div id="cc_content"></div>
    <h3>Suggestions for improvement (Critical Care):</h3>
    <textarea data-name="Suggestions_CC" placeholder="Your feedback..."></textarea>
    <div id="cc_time_content"></div>
    <div class="nav-container"><button class="btn btn-prev" onclick="showSection(2)">← Back</button><button class="btn btn-next" onclick="showSection(4)">Continue →</button></div>
</div>

<div id="section4" class="section-card">
    <h2>(4) Preparation for Future Practice</h2>
    <h3>1. Have you already graduated from fellowship?</h3>
    <input type="radio" name="grad_status" value="Yes" onclick="toggleGradSection(true)"> Yes &nbsp; 
    <input type="radio" name="grad_status" value="No" onclick="toggleGradSection(false)"> No
    
    <div id="grad_section" class="hidden-content">
        <div id="prep_content"></div>
    </div>

    <div class="nav-container"><button class="btn btn-prev" onclick="showSection(3)">← Back</button><button class="btn btn-next" onclick="showSection(5)">Continue →</button></div>
</div>

<div id="section5" class="section-card">
    <h2>(5) The Future of the Fellowship</h2>
    <p>Please provide any additional thoughts you have about the future combined fellowship- this could be about the organization of the fellowship (e.g. pros/cons of having fellowship pathways) or about program leadership, specific rotations, or building community across sites.</p>
    <textarea data-name="Future_Combined_Thoughts" style="height: 250px;" placeholder="Type your thoughts here..."></textarea>
    <div class="nav-container"><button class="btn btn-prev" onclick="showSection(4)">← Back</button><button class="btn btn-submit" onclick="submitFinalSurvey()">Submit Final Survey</button></div>
</div>

<script>
    const rotationData = {
        bwh: ["BWH Pulmonary Consults", "BWH Lung Transplant", "BWH PVD", "BWH Physio", "BWH MICU", "BWH NeuroICU", "BWH SICU", "BWH TSICU", "BWH CSICU", "Spaulding", "Children's Hospital CF Service", "BWH Continuity Clinic", "BWFH Continuity Clinic"],
        mgh: ["MGH Blake 12", "MGH Pulmonary Consults", "MGH Physiology", "MGH Lung Transplant", "MGH MICU", "MGH RACU", "MGH NeuroICU", "MGH CSICU", "MGH Continuity Clinic"],
        bidmc: ["BIDMC IP", "BIDMC Pulmonary Consults", "BIDMC FICU", "BIDMC MICU Blue", "BIDMC SICU", "BIDMC Continuity Clinic"],
        va: ["VA PACC", "VA MICU"]
    };

    function initSection1() {
        for (const site in rotationData) {
            const table = document.getElementById(site + '_table');
            if (!table) continue;
            let html = `<thead><tr><th style="width:220px">Rotation</th><th>positives about the rotation</th><th>negatives about the rotation</th><th>unique contributions (if any) to training experience</th><th style="width:80px">I did not do this rotation</th></tr></thead><tbody>`;
            rotationData[site].forEach((name, i) => {
                const rowId = `${site}-row-${i}`;
                html += `<tr id="${rowId}"><td class="col-name">${name}</td><td><textarea data-name="${name}_Pos"></textarea></td><td><textarea data-name="${name}_Neg"></textarea></td><td><textarea data-name="${name}_Unique"></textarea></td><td class="center-cell"><input type="checkbox" data-name="${name}_Skip" onclick="document.getElementById('${rowId}').classList.toggle('row-disabled', this.checked)"></td></tr>`;
            });
            table.innerHTML = html + `</tbody>`;
        }
    }

    function toggleHospital(site, show) { document.getElementById(site + '_content').style.display = show ? 'block' : 'none'; }
    function toggleGradSection(show) { document.getElementById('grad_section').style.display = show ? 'block' : 'none'; }
    function showSection(n) { document.querySelectorAll('.section-card').forEach(s => s.classList.remove('active-section')); document.getElementById('section'+n).classList.add('active-section'); window.scrollTo(0,0); }

    function buildMatrix(containerId, title, items, namePrefix, labels) {
        let html = `<h3>${title}</h3><table><thead><tr><th class="col-name">Category</th>`;
        labels.forEach(l => html += `<th>${l}</th>`);
        html += `</tr></thead><tbody>`;
        items.forEach((item, i) => {
            html += `<tr><td class="col-name">${item}</td>`;
            for (let j=0; j<labels.length; j++) { html += `<td class="center-cell"><input type="radio" name="${namePrefix}_${i}" value="${labels[j]}"></td>`; }
            html += `</tr>`;
        });
        document.getElementById(containerId).innerHTML += html + `</tbody></table>`;
    }

    // Initializers
    initSection1();
    
    // Section 2 matrices
    buildMatrix('pulm_content', 'Satisfaction with pulmonary training:', 
        ["Breadth of exposure to pulmonary disease", "Graded autonomy of clinical management (i.e. increasing independence making decisions)", "Didactics (fellow-specific teaching sessions)", "Procedures (thoras, chest tubes, and bronchs)", "Clinical teaching by attendings while on service", "Simulation-based teaching"], 
        'pulm_sat', ["Very Dissatisfied", "Somewhat Dissatisfied", "Neutral", "Somewhat Satisfied", "Very Satisfied"]);

    buildMatrix('pulm_time_content', 'Please let us know if the amount of **TIME** on different rotations providing you with these pulmonary experiences was adequate or not:',
        ["general pulmonary consults", "lung transplant", "PVD", "CF", "outpatient general pulmonary", "outpatient pulmonary subspecialties", "physiology", "LTAC experience"],
        'pulm_time', ["not enough time dedicated to this", "right amount of time dedicated to this", "too much time dedicated to this"]);

    // Section 3 matrices
    buildMatrix('cc_content', 'Satisfaction with critical care training:', 
        ["breadth of exposure to critical care medicine disease processes", "graded autonomy of clinical management (increasing independence in decision-making)", "didactics (fellow-specific teaching sessions)", "procedures (a-lines and CVLs)", "clinical teaching by attendings while on service", "simulation-based teaching", "intubation"], 
        'cc_sat', ["Very Dissatisfied", "Somewhat Dissatisfied", "Neutral", "Somewhat Satisfied", "Very Satisfied"]);

    buildMatrix('cc_time_content', 'Please let us know if the amount of **TIME** on different rotations providing you with these critical care experiences was adequate or not:',
        ["medical ICU", "general surgical ICU", "thoracic surgical ICU", "neuro ICU", "CCU", "cardiothoracic surgery ICU", "VV-ECMO", "VA-ECMO"],
        'cc_time', ["not enough time dedicated to this", "right amount of time dedicated to this", "too much time dedicated to this"]);

    // Section 4 matrices
    buildMatrix('prep_content', '2. To what extent do you feel fellowship prepared you for your future practice in terms of:', 
        ["clinical practice in pulmonary medicine", "clinical practice in critical care medicine", "communication with patients", "communication with other physicians", "communication with other professions", "quality improvement practices", "research skills", "leadership skills"], 
        'prepsat', ["Very Unprepared", "Somewhat Unprepared", "Neutral", "Somewhat Prepared", "Very Prepared"]);

    async function submitFinalSurvey() {
        const url = 'https://script.google.com/macros/s/AKfycbw5BTfbMzlCkLtoeQOqktgwtNPALPc0tTq0SZME7LpP1_BoywXPIB9WfqaLk6gMpWqo/exec';
        document.getElementById('loadingOverlay').style.display = 'block';
        const payload = {};
        document.querySelectorAll('textarea').forEach(t => { if(t.value) payload[t.getAttribute('data-name')] = t.value; });
        document.querySelectorAll('input[type="radio"]:checked').forEach(r => payload[r.name] = r.value);
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(c => payload[c.getAttribute('data-name')] = "Skipped");
        try {
            await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
            alert("Survey successfully submitted anonymously. Thank you!"); location.reload();
        } catch (e) { alert("Error submitting."); document.getElementById('loadingOverlay').style.display = 'none'; }
    }
</script>
</body>
</html>
